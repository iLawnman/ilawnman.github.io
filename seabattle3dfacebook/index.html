<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | SeaBattle3D</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
      <!-- <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">SeaBattle3D</div>
      </div> -->
    </div>

    <script src="https://connect.facebook.net/en_US/fbinstant.6.2.js"></script>
    
    <script>

    const display = window.Display;
    //Facebook Instance init
    window.onload = function() {
      FBInstant.initializeAsync()
      .then(FBInstant.startGameAsync)
      .then(onStart);
    }

    function onStart() {
      let entryPointData = FBInstant.getEntryPointData();
      if (entryPointData) {
        $('#bot-data').html(JSON.stringify(entryPointData));
      }

      FBInstant.matchPlayerAsync()
        .then(function() {
          console.log(FBInstant.context.getID());
            // 3456
          });

          FBInstant.context
  .chooseAsync()
  .then(function() {
    console.log(FBInstant.context.getID());
    // 1234567890
  });

          var connectedPlayers = FBInstant.player.getConnectedPlayersAsync()
  .then(function(players) {
    console.log(players.map(function(player) {
      return {
        id: player.getID(),
        name: player.getName(),
      }
    }));
  });
    }

      //UnityInstance init
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/seabattle3dfacebook.loader.js";
      var config = {
        dataUrl: buildUrl + "/seabattle3dfacebook.data",
        frameworkUrl: buildUrl + "/seabattle3dfacebook.framework.js",
        codeUrl: buildUrl + "/seabattle3dfacebook.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "iLawn",
        productName: "SeaBattle3D",
        productVersion: "0.1",
      };

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      //var loadingBar = document.querySelector("#unity-loading-bar");
      //var progressBarFull = document.querySelector("#unity-progress-bar-full");
      //var fullscreenButton = document.querySelector("#unity-fullscreen-button");

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        config.devicePixelRatio = 1;
      } else {
        canvas.style.width = "1080px";
        canvas.style.height = "960px";
      }
      //loadingBar.style.display = "block";

      var script = document.createElement("script");
      var unityInstance;
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config
        // (progress) => {
        //   progressBarFull.style.width = 100 * progress + "%";
        //}
        ).then((ui) => {
          unityInstance = ui;
          //loadingBar.style.display = "none";
          // fullscreenButton.onclick = () => {
          //   unityInstance.SetFullscreen(1);
          // };
        })
        // .catch((message) => {
        //   alert(message);
        //});
      };
      document.body.appendChild(script);

      //send device rotation to unity
      function doOnOrientationChange()
      {
        switch(window.orientation) 
        {  
          case -90:
          case 90:
          unityInstance.SendMessage('BattleScene', 'ReceivedBrowserData', 0);
           break; 
          default:
          unityInstance.SendMessage('BattleScene', 'ReceivedBrowserData', 1);
            break;  
        }
      };
     
      window.addEventListener('orientationchange', doOnOrientationChange);
      window.addEventListener('messaging_game_plays', receivedGameplay);
      //doOnOrientationChange(); // start init

// Process game_play webhook from sendBotData
//
function receivedGameplay(event) {
  // Messenger platform Page-Scope ID
  var senderId = event.sender.id; 
  // FBInstant player id
  var PlayerId = event.game_play.player_id; 
  // FBInstant context id
  var contextId = event.game_play.context_id;
  if (event.game_play.payload) {
    // Get data from payload
    var payload = JSON.parse(event.game_play.payload);
    var player = payload['Player'];
    var place = payload['Place'];

    // show data
    if (senderId != playerId) {
    if (player) {
        console.log(player);
        console.log(place);
        console.log('sender player id ' + senderId + ' local player id ' + playerId );
        
        unityInstance.SendMessage('BattleScene', 'ReceiveShot', place);
    }
  }
  }
}
// call from unityInstance
function SendShotToInstance (str) {
    // var botData = str;
    // FBInstant.setSessionData({
    //          str});
    console.log('income shot ' + str);
    FBInstant.updateAsync({
  action: 'CUSTOM',
  template: 'play_turn',
  shot: str,
  });
  FBInstant.quit();
}
</script>
  </body>
</html>
